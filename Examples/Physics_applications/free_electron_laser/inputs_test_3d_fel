my_constants.gamma_bunch=100.6
my_constants.Bu = 0.5
my_constants.lambda_u = 3e-2
my_constants.k_u= 2*pi/lambda_u
my_constants.K = q_e*Bu/(m_e*clight*k_u) # Undulator parameter
my_constants.L_ramp = 3e-2 # Length of the undulator ramp
# Initial kick to compensate the non-zero B integral in the ramp
my_constants.initial_ux0 = q_e*Bu*L_ramp/(m_e*clight) * 1/( 1 + (k_u*L_ramp)*(k_u*L_ramp) )

warpx.gamma_boost = gamma_bunch/sqrt(1+K*K/2) # Lorentz factor of the ponderomotive frame
warpx.boost_direction = z
algo.maxwell_solver = yee
algo.particle_shape = 2
algo.particle_pusher = vay

# geometry
geometry.dims = 3
geometry.prob_hi =  400e-6  400e-6     0
geometry.prob_lo = -400e-6 -400e-6  -110e-6

amr.max_level = 0
amr.n_cell = 16 16 1024

# boundary
boundary.field_hi = pml pml pml
boundary.field_lo = pml pml pml
boundary.particle_hi = absorbing absorbing absorbing
boundary.particle_lo = absorbing absorbing absorbing

# diagnostics
diagnostics.diags_names = diag_labframe diag_boostedframe

# Diagnostic that show quantities in the frame
# of the simulation (boosted-frame)
diag_boostedframe.diag_type = Full
diag_boostedframe.format = openpmd
diag_boostedframe.intervals = 100
diag_boostedframe.fields_to_plot = Ex Ey Ez Bx By Bz jx jy jz rho rho_electrons rho_positrons

# Diagnostic that show quantities
# reconstructed in the lab frame
diag_labframe.diag_type = BackTransformed
diag_labframe.num_snapshots_lab = 20
diag_labframe.dz_snapshots_lab = 0.1
diag_labframe.format = openpmd

# Run the simulation long enough for
# all backtransformed diagnostic to be complete
max_step = 2500

particles.species_names = electrons positrons
particles.rigid_injected_species= electrons positrons

electrons.charge = -q_e
electrons.injection_style = nuniformpercell
electrons.mass = m_e
electrons.momentum_distribution_type = constant
electrons.num_particles_per_cell_each_dim = 2 2 2
electrons.profile = constant
electrons.density = 2.7e19/2
electrons.ux = +initial_ux0
electrons.uy = 0.0
electrons.uz = gamma_bunch
electrons.zmax = -50e-6
electrons.zmin = -150e-6
electrons.xmax = 130e-6
electrons.xmin = -130e-6
electrons.ymax = 130e-6
electrons.ymin = -130e-6
electrons.zinject_plane=0.0
electrons.rigid_advance=0

positrons.charge = q_e
positrons.injection_style = nuniformpercell
positrons.mass = m_e
positrons.momentum_distribution_type = constant
positrons.num_particles_per_cell_each_dim = 2 2 2
positrons.profile = constant
positrons.density = 2.7e19/2
positrons.ux = -initial_ux0
positrons.uy = 0.0
positrons.uz = gamma_bunch
positrons.zmax = -50e-6
positrons.zmin = -150e-6
positrons.xmax = 130e-6
positrons.xmin = -130e-6
positrons.ymax = 130e-6
positrons.ymin = -130e-6
positrons.zinject_plane=0.0
positrons.rigid_advance=0

warpx.do_moving_window = 1
warpx.moving_window_dir = z
warpx.moving_window_v = sqrt(1-(1+K*K/2)/(gamma_bunch*gamma_bunch))

# Undulator field
particles.B_ext_particle_init_style = parse_B_ext_particle_function
particles.Bx_external_particle_function(x,y,z,t) = 0
particles.By_external_particle_function(x,y,z,t) = if( z>0, Bu*cos(k_u*z)*(1-exp(-z/L_ramp)), 0 )
particles.Bz_external_particle_function(x,y,z,t) =0.0

warpx.cfl = 0.99
