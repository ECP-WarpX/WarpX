

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Particles &mdash; WarpX  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Initialization" href="initialization.html" />
    <link rel="prev" title="Fields" href="fields.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> WarpX
          

          
          </a>

          
            
            
              <div class="version">
                20.02
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../building/building.html">Building/installing WarpX</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_cpp/running_cpp.html">Running WarpX as an executable</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_python/running_python.html">Running WarpX from Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization/visualization.html">Visualizing the simulation results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../theory/theory.html">Theoretical background</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developers.html">Developers documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="amrex_basics.html">AMReX basics (excessively basic)</a></li>
<li class="toctree-l2"><a class="reference internal" href="repo_organization.html">WarpX structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="fields.html">Fields</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Particles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#particle-containers">Particle containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loop-over-particles">Loop over particles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#link-fields-and-particles">Link fields and particles?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#main-functions">Main functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#buffers">Buffers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="initialization.html">Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html">Diagnostics</a></li>
<li class="toctree-l2"><a class="reference internal" href="moving_window.html">Moving Window</a></li>
<li class="toctree-l2"><a class="reference internal" href="portability.html">Portability</a></li>
<li class="toctree-l2"><a class="reference internal" href="profiling.html">Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="documentation.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">Workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="doxygen.html">Doxygen</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">WarpX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="developers.html">Developers documentation</a> &raquo;</li>
        
      <li>Particles</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developers/particles.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="particles">
<span id="developers-particles"></span><h1>Particles<a class="headerlink" href="#particles" title="Permalink to this headline">¶</a></h1>
<div class="section" id="particle-containers">
<h2>Particle containers<a class="headerlink" href="#particle-containers" title="Permalink to this headline">¶</a></h2>
<p>Particle structures and functions are defined in <code class="docutils literal notranslate"><span class="pre">Source/Particles/</span></code>. WarpX uses the <code class="docutils literal notranslate"><span class="pre">Particle</span></code> class from AMReX for single particles. An ensemble of particles (e.g., a plasma species, or laser particles) is stored as a <code class="docutils literal notranslate"><span class="pre">WarpXParticleContainer</span></code> (see description below) in a per-box (and even per-tile on CPU) basis.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<p>Physical species are stored in <code class="docutils literal notranslate"><span class="pre">PhysicalParticleContainer</span></code>, that derives from <code class="docutils literal notranslate"><span class="pre">WarpXParticleContainer</span></code>. In particular, the main function to advance all particles in a physical species is <code class="docutils literal notranslate"><span class="pre">PhysicalParticleContainer::Evolve</span></code> (see below).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<p>Finally, all particle species (physical plasma species <code class="docutils literal notranslate"><span class="pre">PhysicalParticleContainer</span></code>, photon species <code class="docutils literal notranslate"><span class="pre">PhotonParticleContainer</span></code> or non-physical species <code class="docutils literal notranslate"><span class="pre">LaserParticleContainer</span></code>) are stored in <code class="docutils literal notranslate"><span class="pre">MultiParticleContainer</span></code>. The class <code class="docutils literal notranslate"><span class="pre">WarpX</span></code> holds one instance of <code class="docutils literal notranslate"><span class="pre">MultiParticleContainer</span></code> as a member variable, called <code class="docutils literal notranslate"><span class="pre">WarpX::mypc</span></code> (where <cite>mypc</cite> stands for “my particle containers”):</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenclass: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
</div>
<div class="section" id="loop-over-particles">
<h2>Loop over particles<a class="headerlink" href="#loop-over-particles" title="Permalink to this headline">¶</a></h2>
<p>A typical loop over particles reads:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// pc is a std::unique_ptr&lt;WarpXParticleContainer&gt;</span>
<span class="c1">// Loop over MR levels</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">lev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lev</span> <span class="o">&lt;=</span> <span class="n">finest_level</span><span class="p">;</span> <span class="o">++</span><span class="n">lev</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Loop over particles, box by box</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">WarpXParIter</span> <span class="n">pti</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">lev</span><span class="p">);</span> <span class="n">pti</span><span class="p">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">pti</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Do something on particles</span>
        <span class="c1">// [MY INNER LOOP]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The innermost step <code class="docutils literal notranslate"><span class="pre">[MY</span> <span class="pre">INNER</span> <span class="pre">LOOP]</span></code> typically calls <code class="docutils literal notranslate"><span class="pre">amrex::ParallelFor</span></code> to perform operations on all particles in a portable way. For this reasons, the particle data needs to be converted in plain-old-data structures. The innermost loop in the code snippet above could look like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Get Array-Of-Struct particle data, also called data</span>
<span class="c1">// (x, y, z, id, cpu)</span>
<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">particles</span> <span class="o">=</span> <span class="n">pti</span><span class="p">.</span><span class="n">GetArrayOfStructs</span><span class="p">();</span>
<span class="c1">// Get Struct-Of-Array particle data, also called attribs</span>
<span class="c1">// (ux, uy, uz, w, Exp, Ey, Ez, Bx, By, Bz)</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">attribs</span> <span class="o">=</span> <span class="n">pti</span><span class="p">.</span><span class="n">GetAttribs</span><span class="p">();</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">Exp</span> <span class="o">=</span> <span class="n">attribs</span><span class="p">[</span><span class="n">PIdx</span><span class="o">::</span><span class="n">Ex</span><span class="p">];</span>
<span class="c1">// [...]</span>
<span class="c1">// Number of particles in this box</span>
<span class="k">const</span> <span class="kt">long</span> <span class="n">np</span> <span class="o">=</span> <span class="n">pti</span><span class="p">.</span><span class="n">numParticles</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="link-fields-and-particles">
<h2>Link fields and particles?<a class="headerlink" href="#link-fields-and-particles" title="Permalink to this headline">¶</a></h2>
<p>In WarpX, the loop over boxes through a <code class="docutils literal notranslate"><span class="pre">MultiFab</span></code> iterator <code class="docutils literal notranslate"><span class="pre">MFIter</span></code> and the loop over boxes through a <code class="docutils literal notranslate"><span class="pre">ParticleContainer</span></code> iterator <code class="docutils literal notranslate"><span class="pre">WarpXParIter</span></code> are consistent.</p>
<p>On a loop over boxes in a <code class="docutils literal notranslate"><span class="pre">MultiFab</span></code> (<code class="docutils literal notranslate"><span class="pre">MFIter</span></code>), it can be useful to access particle data on a GPU-friendly way. This can be done by:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Index of grid (= box)</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">grid_id</span> <span class="o">=</span> <span class="n">mfi</span><span class="p">.</span><span class="n">index</span><span class="p">();</span>
<span class="c1">// Index of tile within the grid</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">tile_id</span> <span class="o">=</span> <span class="n">mfi</span><span class="p">.</span><span class="n">LocalTileIndex</span><span class="p">();</span>
<span class="c1">// Get GPU-friendly arrays of particle data</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">ptile</span> <span class="o">=</span> <span class="n">GetParticles</span><span class="p">(</span><span class="n">lev</span><span class="p">)[</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">grid_id</span><span class="p">,</span><span class="n">tile_id</span><span class="p">)];</span>
<span class="n">ParticleType</span><span class="o">*</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">particle_tile</span><span class="p">.</span><span class="n">GetArrayOfStructs</span><span class="p">()().</span><span class="n">data</span><span class="p">();</span>
<span class="c1">// Only need attribs (i.e., SoA data)</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">soa</span> <span class="o">=</span> <span class="n">ptile</span><span class="p">.</span><span class="n">GetStructOfArrays</span><span class="p">();</span>
<span class="c1">// As an example, let&#39;s get the ux momentum</span>
<span class="k">const</span> <span class="n">ParticleReal</span> <span class="o">*</span> <span class="k">const</span> <span class="n">AMREX_RESTRICT</span> <span class="n">ux</span> <span class="o">=</span> <span class="n">soa</span><span class="p">.</span><span class="n">GetRealData</span><span class="p">(</span><span class="n">PIdx</span><span class="o">::</span><span class="n">ux</span><span class="p">).</span><span class="n">data</span><span class="p">();</span>
</pre></div>
</div>
<p>On a loop over particles it can be useful to access the fields on the box we are looping over (typically when we use both field and particle data on the same box, for field gather or current deposition for instance). This is done for instance by adding this snippet in <code class="docutils literal notranslate"><span class="pre">[MY</span> <span class="pre">INNER</span> <span class="pre">LOOP]</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// E is a reference to, say, WarpX::Efield_aux</span>
<span class="c1">// Get the Ex field on the grid</span>
<span class="k">const</span> <span class="n">FArrayBox</span><span class="o">&amp;</span> <span class="n">exfab</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">E</span><span class="p">[</span><span class="n">lev</span><span class="p">][</span><span class="mi">0</span><span class="p">])[</span><span class="n">pti</span><span class="p">];</span>
<span class="c1">// Let&#39;s be generous and also get the underlying box (i.e., index info)</span>
<span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">box</span> <span class="o">=</span> <span class="n">pti</span><span class="p">.</span><span class="n">validbox</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="main-functions">
<h2>Main functions<a class="headerlink" href="#main-functions" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current deposition is used both by <code class="docutils literal notranslate"><span class="pre">PhysicalParticleContainer</span></code> and <code class="docutils literal notranslate"><span class="pre">LaserParticleContainer</span></code>, so it is in the parent class <code class="docutils literal notranslate"><span class="pre">WarpXParticleContainer</span></code>.</p>
</div>
</div>
<div class="section" id="buffers">
<h2>Buffers<a class="headerlink" href="#buffers" title="Permalink to this headline">¶</a></h2>
<p>To reduce numerical artifacts at the boundary of a mesh-refinement patch, WarpX has an option to use buffers: When particles evolve on the fine level, they gather from the coarse level (e.g., <code class="docutils literal notranslate"><span class="pre">Efield_cax</span></code>, a copy of the <code class="docutils literal notranslate"><span class="pre">aux</span></code> data from the level below) if they are located on the fine level but fewer than <code class="docutils literal notranslate"><span class="pre">WarpX::n_field_gather_buffer</span></code> cells away from the coarse-patch boundary. Similarly, when particles evolve on the fine level, they deposit on the coarse level (e.g., <code class="docutils literal notranslate"><span class="pre">Efield_cp</span></code>) if they are located on the fine level but fewer than <code class="docutils literal notranslate"><span class="pre">WarpX::n_current_deposition_buffer</span></code> cells away from the coarse-patch boundary.</p>
<p><code class="docutils literal notranslate"><span class="pre">WarpX::gather_buffer_masks</span></code> and <code class="docutils literal notranslate"><span class="pre">WarpX::current_buffer_masks</span></code> contain masks indicating if a cell is in the interior of the fine-resolution patch or in the buffers. Then, particles depending on this mask in</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>doxygenfunction: Cannot find file: /Users/diana/Documents/opt/WarpX/Docs/doxyxml/index.xml</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Buffers are complex!</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="initialization.html" class="btn btn-neutral float-right" title="Initialization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fields.html" class="btn btn-neutral float-left" title="Fields" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, WarpX collaboration

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>